// --- æ•°æ®æ¨¡å‹å®šä¹‰ ---
type FactorSource = 'DATABASE' | 'PYTHON';

interface Factor {
  id: string;
  name: string;
  code: string;
  source: FactorSource;
}

// [ä¼˜åŒ–] ä¸ºæ ‘èŠ‚ç‚¹æ·»åŠ  isExpanded å±æ€§ï¼Œç”¨äºä¿å­˜å…¶å±•å¼€çŠ¶æ€
interface TreeNode {
  id: string;
  name: string;
  isCategory: boolean;
  children?: TreeNode[];
  factor?: Factor;
  isExpanded?: boolean; // ç”¨äº DisclosureGroup
}

// --- é™æ€æ¨¡æ‹Ÿæ•°æ® ---
const MOCK_FACTORS: Factor[] = [
  { id: 'f1', name: 'è¿‘ä¸€æœˆæ”¶ç›Šç‡', code: 'RETURN_1M', source: 'DATABASE' },
  { id: 'f2', name: 'å¸‚å€¼ï¼ˆå¯¹æ•°ï¼‰', code: 'LOG_MKT_CAP', source: 'DATABASE' },
  { id: 'f3', name: 'æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰', code: 'VOLATILITY_ANNUAL', source: 'PYTHON' },
  { id: 'f4', name: 'BPä¼°å€¼å› å­', code: 'BP_RATIO', source: 'PYTHON' },
];

const MOCK_FACTOR_TREE: TreeNode = {
  id: 'root',
  name: 'ä¸»å› å­æ ‘',
  isCategory: true,
  isExpanded: true, // [ä¼˜åŒ–] æ ¹èŠ‚ç‚¹é»˜è®¤å±•å¼€
  children: [
    {
      id: 'cat1', name: 'ä»·å€¼å› å­', isCategory: true, isExpanded: false, children: [
      { id: 'leaf1', name: 'BPä¼°å€¼å› å­', isCategory: false, factor: MOCK_FACTORS[3] }
    ]
    },
    {
      id: 'cat2', name: 'åŠ¨é‡å› å­', isCategory: true, isExpanded: true, children: [
      { id: 'leaf2', name: 'è¿‘ä¸€æœˆæ”¶ç›Šç‡', isCategory: false, factor: MOCK_FACTORS[0] }
    ]
    },
    { id: 'leaf3', name: 'æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰', isCategory: false, factor: MOCK_FACTORS[2] }
  ]
};

// --- UI ç»„ä»¶ ---

/**
 * å› å­åˆ—è¡¨ä¸­çš„å•ä¸ªåˆ—è¡¨é¡¹
 */
@Builder
function FactorListItem(factor: Factor) {
  Row({ space: 12 }) {
    // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£å›¾æ ‡
    Text(factor.source === 'DATABASE' ? 'ğŸ’¾' : 'ğŸ')
      .fontSize(24)
    Column({ space: 4 }) {
      Text(factor.name).fontSize(16).fontWeight(FontWeight.Medium)
      Text(factor.code).fontSize(12).fontColor(Color.Gray)
    }.alignItems(HorizontalAlign.Start).layoutWeight(1)
    // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£å›¾æ ‡
    Text('â‹®').fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Gray)
  }
  .padding(15).backgroundColor(Color.White).borderRadius(12)
}

/**
 * é€’å½’æ„å»ºå› å­æ ‘çš„UI
 */
@Builder
function TreeView(node: TreeNode) {
  if (node.isCategory) {
    // [ä¼˜åŒ–] ç»‘å®š isExpanded çŠ¶æ€ï¼Œå¹¶æä¾› onToggle å›è°ƒæ¥æ›´æ–°çŠ¶æ€
    DisclosureGroup({
      isExpanded: node.isExpanded,
      onToggle: (isExpanded: boolean) => {
        node.isExpanded = isExpanded;
      }
    }) {
      Row({ space: 8 }) {
        // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£å›¾æ ‡
        Text('ğŸ“').fontSize(20)
        Text(node.name).fontSize(16).fontWeight(FontWeight.Bold)
      }
    } content: {
      Column() {
        if (node.children) {
          // [ä¼˜åŒ–] ä¸º ForEach æ·»åŠ  key
          ForEach(node.children, (childNode: TreeNode) => {
            TreeView(childNode) // é€’å½’è°ƒç”¨
          }, (childNode: TreeNode) => childNode.id)
        }
      }.padding({ left: 20 })
    }
  } else if (node.factor) {
    FactorListItem(node.factor)
  }
}


/**
 * åˆ›å»ºæ–°å› å­çš„é¡µé¢
 */
@Component
struct CreateFactorPage {
  @Link isCreating: boolean;
  @State factorName: string = '';
  @State factorCode: string = '';
  @State selectedSource: FactorSource = 'DATABASE';
  @State pythonScript: string = '# åœ¨æ­¤è¾“å…¥Pythonä»£ç \n# ä¾‹å¦‚: df["new_factor"] = df["price"] / df["earnings"]';

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 15 }) {
        // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£å›¾æ ‡
        Text('âŒ').fontSize(20).onClick(() => this.isCreating = false)
        // [ä¼˜åŒ–] ä½¿ç”¨ Blank ç»„ä»¶ç¡®ä¿æ ‡é¢˜å±…ä¸­
        Blank()
        Text("åˆ›å»ºæ–°å› å­").fontSize(20).fontWeight(FontWeight.Bold)
        Blank()
        Text("ä¿å­˜").fontSize(16).fontColor(Color.Blue).onClick(() => this.isCreating = false)
      }
      .width('100%').padding(15).backgroundColor(Color.White)
      .shadow({ radius: 4, color: '#1F000000', offsetY: 2 })

      // 2. è¡¨å•å†…å®¹
      Scroll() {
        Column({ space: 20 }) {
          TextInput({ placeholder: 'å› å­åç§°ï¼Œå¦‚ï¼šå¸‚å‡€ç‡' }).onChange(val => this.factorName = val)
          TextInput({ placeholder: 'å› å­ç¼–ç ï¼Œå¦‚ï¼šPB_RATIO' }).onChange(val => this.factorCode = val)

          Column({ space: 10 }) {
            Text("å› å­æ¥æº").fontSize(16).fontWeight(FontWeight.Medium)
            // [ä¿®æ­£] ä½¿ç”¨æ–°çš„ RadioGroup å†™æ³•ï¼Œæ›´ç®€æ´ã€æ ‡å‡†
            RadioGroup({
              value: this.selectedSource,
              group: 'source',
              onChange: (value: string) => {
                this.selectedSource = value as FactorSource;
              }
            }) {
              Row({ space: 5 }) { Radio({ value: 'DATABASE' }); Text("æ•°æ®åº“") }
              Row({ space: 5 }) { Radio({ value: 'PYTHON' }); Text("Pythonè„šæœ¬") }
            }.direction(Axis.Horizontal).width('100%').justifyContent(FlexAlign.SpaceAround)
          }.alignItems(HorizontalAlign.Start)

          if (this.selectedSource === 'DATABASE') {
            Column({ space: 10 }) {
              TextInput({ placeholder: 'æ•°æ®æºåç§°' })
              TextInput({ placeholder: 'æ•°æ®è¡¨å' })
              TextInput({ placeholder: 'å­—æ®µå' })
            }.transition(TransitionEffect.OPACITY.animation({ duration: 300 }))
          } else {
            TextArea({ placeholder: "è¾“å…¥Pythonè„šæœ¬...", text: this.pythonScript })
              .height(200).fontFamily("Consolas, monaco, monospace") // [ä¼˜åŒ–] ä½¿ç”¨ç­‰å®½å­—ä½“
              .onChange(val => this.pythonScript = val)
              .transition(TransitionEffect.OPACITY.animation({ duration: 300 }))
          }
        }.padding(15).width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor('#f5f5f5')
  }
}


/**
 * ä¸»é¡µé¢
 */
@Entry
@Component
struct FactorManagementPage {
  @State selectedTabIndex: number = 0;
  @State factors: Factor[] = MOCK_FACTORS;
  @State factorTree: TreeNode = MOCK_FACTOR_TREE;
  @State selectedTreeNameIndex: number = 0;
  @State isCreating: boolean = false;
  private tabsController: TabsController = new TabsController();
  private treeOptions: string[] = ["ä¸»å› å­æ ‘", "é‡åŒ–æŠ•é¡¾æ ‘", "ç‰¹è‰²æ•°æ®æ ‘"];

  build() {
    Stack() {
      Column() {
        Tabs({ barPosition: BarPosition.Start, controller: this.tabsController }) {
          Tab("å› å­åˆ—è¡¨") { this.FactorList() }
          Tab("å› å­æ ‘") { this.FactorTree() }
          Tab("é£æ ¼å› å­") { this.StyleFactor() }
        }.onChange((index) => { this.selectedTabIndex = index })
      }.width('100%').height('100%')

      if (this.selectedTabIndex === 0 && !this.isCreating) {
        Button({ type: ButtonType.Circle }) {
          Text("+").fontSize(30).fontColor(Color.White)
        }
        .width(56).height(56).position({ x: '85%', y: '88%' })
        .onClick(() => { this.isCreating = true }).shadow({ radius: 6, color: '#33000000' })
      }

      if (this.isCreating) {
        CreateFactorPage({ isCreating: $isCreating })
          .transition(TransitionEffect.move(TransitionEdge.BOTTOM))
      }
    }.animation({ duration: 300, curve: Curve.EaseInOut })
  }

  @Builder FactorList() {
    Column() {
      TextInput({ placeholder: 'æœç´¢å› å­...' }).margin(15)
      List({ space: 10 }) {
        // [ä¼˜åŒ–] ä¸º ForEach æ·»åŠ  key
        ForEach(this.factors, (factor: Factor) => {
          ListItem() { FactorListItem(factor) }
        }, (factor: Factor) => factor.id)
      }.padding({ horizontal: 15 })
    }.backgroundColor('#f5f5f5') // [ä¼˜åŒ–] ç»Ÿä¸€èƒŒæ™¯è‰²
  }

  @Builder FactorTree() {
    Column() {
      Select(this.treeOptions)
        .selected(this.selectedTreeNameIndex)
        .onSelect((index, value) => { this.selectedTreeNameIndex = index; })
        .margin(15)
      Scroll() {
        TreeView(this.factorTree)
      }.padding({ horizontal: 15 })
    }.backgroundColor('#f5f5f5') // [ä¼˜åŒ–] ç»Ÿä¸€èƒŒæ™¯è‰²
  }

  @Builder StyleFactor() {
    Column({ space: 10 }) {
      Text("é£æ ¼å› å­ç®¡ç†é¡µé¢").fontSize(20)
      Text("æ­¤å¤„ç”¨äºç®¡ç†é€šè¿‡å¤šå› å­åŠ æƒåˆ›å»ºçš„é£æ ¼åˆ†ç±»ã€‚").padding({ horizontal: 20 }).fontColor(Color.Gray)
    }
    .width('100%').height('100%').justifyContent(FlexAlign.Center)
    .backgroundColor('#f5f5f5') // [ä¼˜åŒ–] ç»Ÿä¸€èƒŒæ™¯è‰²
  }
}