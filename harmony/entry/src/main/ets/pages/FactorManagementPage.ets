type FactorSource = 'DATABASE' | 'PYTHON';

interface Factor {
  id: string;
  name: string;
  code: string;
  source: FactorSource;
}

// æ ‘èŠ‚ç‚¹æ¨¡å‹
interface TreeNode {
  id: string;
  name: string;
  isCategory: boolean; // æ˜¯å¦æ˜¯åˆ†ç±»èŠ‚ç‚¹
  children?: TreeNode[];
  factor?: Factor; // å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œåˆ™åŒ…å«å› å­ä¿¡æ¯
}


// --- é™æ€æ¨¡æ‹Ÿæ•°æ® ---
const MOCK_FACTORS: Factor[] = [
  { id: 'f1', name: 'è¿‘ä¸€æœˆæ”¶ç›Šç‡', code: 'RETURN_1M', source: 'DATABASE' },
  { id: 'f2', name: 'å¸‚å€¼ï¼ˆå¯¹æ•°ï¼‰', code: 'LOG_MKT_CAP', source: 'DATABASE' },
  { id: 'f3', name: 'æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰', code: 'VOLATILITY_ANNUAL', source: 'PYTHON' },
  { id: 'f4', name: 'BPä¼°å€¼å› å­', code: 'BP_RATIO', source: 'PYTHON' },
];

const MOCK_FACTOR_TREE: TreeNode = {
  id: 'root',
  name: 'ä¸»å› å­æ ‘',
  isCategory: true,
  children: [
    {
      id: 'cat1', name: 'ä»·å€¼å› å­', isCategory: true, children: [
      { id: 'leaf1', name: 'BPä¼°å€¼å› å­', isCategory: false, factor: MOCK_FACTORS[3] }
    ]
    },
    {
      id: 'cat2', name: 'åŠ¨é‡å› å­', isCategory: true, children: [
      { id: 'leaf2', name: 'è¿‘ä¸€æœˆæ”¶ç›Šç‡', isCategory: false, factor: MOCK_FACTORS[0] }
    ]
    },
    { id: 'leaf3', name: 'æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰', isCategory: false, factor: MOCK_FACTORS[2] }
  ]
};

// --- UI ç»„ä»¶ ---

/**
 * å› å­åˆ—è¡¨ä¸­çš„å•ä¸ªåˆ—è¡¨é¡¹
 */
@Builder
function FactorListItem(factor: Factor) {
  Row({ space: 12 }) {
    // æ ¹æ®æ¥æºæ˜¾ç¤ºä¸åŒå›¾æ ‡
    Text(factor.source === 'DATABASE' ? 'ğŸ’¾' : 'ğŸ')
      .fontSize(24)
    Column({ space: 4 }) {
      Text(factor.name).fontSize(16).fontWeight(FontWeight.Medium)
      Text(factor.code).fontSize(12).fontColor(Color.Gray)
    }.alignItems(HorizontalAlign.Start).layoutWeight(1)
    // æ“ä½œæŒ‰é’®
    Image($r("app.media.ic_more")) // å‡è®¾æœ‰ "æ›´å¤š" å›¾æ ‡
      .width(24).height(24)
  }
  .padding(15).backgroundColor(Color.White).borderRadius(12)
}

/**
 * é€’å½’æ„å»ºå› å­æ ‘çš„UI
 */
@Builder
function TreeView(node: TreeNode) {
  if (node.isCategory) {
    // å¦‚æœæ˜¯åˆ†ç±»ï¼Œä½¿ç”¨å¯æŠ˜å ç»„ä»¶
    DisclosureGroup() {
      // æ ‡é¢˜
      Row({space: 8}) {
        Image($r("app.media.ic_folder")) // å‡è®¾æœ‰æ–‡ä»¶å¤¹å›¾æ ‡
          .width(20).height(20)
        Text(node.name).fontSize(16).fontWeight(FontWeight.Bold)
      }
    } content: {
      // å†…å®¹ï¼Œé€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
      Column() {
        if (node.children) {
          ForEach(node.children, (childNode: TreeNode) => {
            TreeView(childNode) // é€’å½’è°ƒç”¨
          })
        }
      }.padding({ left: 20 }) // å­èŠ‚ç‚¹å‘å³ç¼©è¿›
    }
  } else if (node.factor) {
    // å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼ˆå› å­ï¼‰ï¼Œç›´æ¥æ¸²æŸ“å› å­åˆ—è¡¨é¡¹
    FactorListItem(node.factor)
  }
}


/**
 * åˆ›å»ºæ–°å› å­çš„é¡µé¢ (æ¨¡æ‹Ÿ)
 */
@Component
struct CreateFactorPage {
  @Link isCreating: boolean; // åŒå‘ç»‘å®šï¼Œç”¨äºå…³é—­é¡µé¢
  @State factorName: string = '';
  @State factorCode: string = '';
  @State selectedSource: FactorSource = 'DATABASE';
  @State pythonScript: string = '# åœ¨æ­¤è¾“å…¥Pythonä»£ç \n\n'

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r("app.media.ic_close")).width(24).height(24).onClick(() => this.isCreating = false)
        Text("åˆ›å»ºæ–°å› å­").fontSize(20).fontWeight(FontWeight.Bold).layoutWeight(1).textAlign(TextAlign.Center)
        Text("ä¿å­˜").fontSize(16).fontColor(Color.Blue).onClick(() => this.isCreating = false)
      }
      .width('100%').padding(15).backgroundColor(Color.White)
      .shadow({ radius: 4, color: '#1F000000', offsetY: 2 })

      // 2. è¡¨å•å†…å®¹
      Scroll() {
        Column({space: 20}) {
          TextInput({ placeholder: 'å› å­åç§°ï¼Œå¦‚ï¼šå¸‚å‡€ç‡' }).onChange(val => this.factorName = val)
          TextInput({ placeholder: 'å› å­ç¼–ç ï¼Œå¦‚ï¼šPB_RATIO' }).onChange(val => this.factorCode = val)

          // å› å­æ¥æºé€‰æ‹©
          Column({space: 10}) {
            Text("å› å­æ¥æº").fontSize(16).fontWeight(FontWeight.Medium)
            RadioGroup() {
              Radio({ value: 'DATABASE', group: 'source' }).onChange(isChecked => { if(isChecked) this.selectedSource = 'DATABASE' })
              Text("æ•°æ®åº“")
              Radio({ value: 'PYTHON', group: 'source' }).onChange(isChecked => { if(isChecked) this.selectedSource = 'PYTHON' })
              Text("Pythonè„šæœ¬")
            }.select(this.selectedSource).direction(Axis.Horizontal)
          }.alignItems(HorizontalAlign.Start)

          // æ ¹æ®é€‰æ‹©åŠ¨æ€æ˜¾ç¤ºUI
          if (this.selectedSource === 'DATABASE') {
            Column({space: 10}) {
              TextInput({ placeholder: 'æ•°æ®æºåç§°' })
              TextInput({ placeholder: 'æ•°æ®è¡¨å' })
              TextInput({ placeholder: 'å­—æ®µå' })
            }.transition(TransitionEffect.OPACITY.animation({duration: 300})) // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
          } else {
            TextArea({ placeholder: "è¾“å…¥Pythonè„šæœ¬...", text: this.pythonScript})
              .height(200)
              .onChange(val => this.pythonScript = val)
              .transition(TransitionEffect.OPACITY.animation({duration: 300}))
          }

        }.padding(15).width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%').height('100%').backgroundColor('#f5f5f5')
  }
}

/**
 * ä¸»é¡µé¢
 */
@Entry
@Component
struct FactorManagementPage {
  @State selectedTabIndex: number = 0;
  @State factors: Factor[] = MOCK_FACTORS;
  @State factorTree: TreeNode = MOCK_FACTOR_TREE;
  @State selectedTreeName: number = 0;
  @State isCreating: boolean = false; // æ§åˆ¶åˆ›å»ºé¡µé¢çš„æ˜¾ç¤º

  private tabsController: TabsController = new TabsController();
  private treeOptions: string[] = ["ä¸»å› å­æ ‘", "é‡åŒ–æŠ•é¡¾æ ‘", "ç‰¹è‰²æ•°æ®æ ‘"];

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Tabs({ barPosition: BarPosition.Start, controller: this.tabsController }) {
          Tab("å› å­åˆ—è¡¨") { this.FactorList() }
          Tab("å› å­æ ‘") { this.FactorTree() }
          Tab("é£æ ¼å› å­") { this.StyleFactor() }
        }.onChange((index) => { this.selectedTabIndex = index })
      }.width('100%').height('100%')

      // åˆ›å»ºå› å­æ‚¬æµ®æŒ‰é’® (åªåœ¨ç¬¬ä¸€ä¸ªtabæ˜¾ç¤º)
      if (this.selectedTabIndex === 0 && !this.isCreating) {
        Button({ type: ButtonType.Circle }) {
          Text("+").fontSize(30).fontColor(Color.White)
        }
        .width(56).height(56)
        .position({ x: '85%', y: '88%' })
        .onClick(() => { this.isCreating = true })
        .shadow({ radius: 6, color: '#33000000' })
      }

      // åˆ›å»ºå› å­é¡µé¢ (æ¡ä»¶æ¸²æŸ“ï¼Œå®ç°é¡µé¢è¦†ç›–æ•ˆæœ)
      if (this.isCreating) {
        CreateFactorPage({ isCreating: $isCreating })
          .transition(TransitionEffect.move(TransitionEdge.BOTTOM)) // ä»åº•éƒ¨æ»‘å…¥çš„åŠ¨ç”»
      }
    }.animation({ duration: 300, curve: Curve.EaseInOut })
  }

  // å› å­åˆ—è¡¨ Tab
  @Builder FactorList() {
    Column() {
      TextInput({ placeholder: 'æœç´¢å› å­...' }).margin(15)
      List({ space: 10 }) {
        ForEach(this.factors, (factor: Factor) => {
          ListItem() {
            FactorListItem(factor)
          }
        })
      }.padding({ horizontal: 15 })
    }
  }

  // å› å­æ ‘ Tab
  @Builder FactorTree() {
    Column() {
      // å› å­æ ‘é€‰æ‹©å™¨
      Select(this.treeOptions)
        .selected(this.selectedTreeName)
        .onSelect( (index, value) => {
          this.selectedTreeName = index;
          // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ ¹æ® value é‡æ–°åŠ è½½ä¸åŒçš„å› å­æ ‘æ•°æ®
        })
        .margin(15)

      // æ ‘çŠ¶å›¾
      Scroll() {
        TreeView(this.factorTree)
      }
      .padding({ horizontal: 15 })
    }
  }

  // é£æ ¼å› å­ Tab (ç®€åŒ–å ä½)
  @Builder StyleFactor() {
    Column() {
      Text("é£æ ¼å› å­ç®¡ç†é¡µé¢").fontSize(20).margin(20)
      Text("æ­¤å¤„ç”¨äºç®¡ç†é€šè¿‡å¤šå› å­åŠ æƒåˆ›å»ºçš„é£æ ¼åˆ†ç±»ã€‚").padding({horizontal: 20})
    }.width('100%')
  }
}
