// ä¸ºäº†ä»£ç çš„å¯è¯»æ€§ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰å¥½éœ€è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„
interface Fund {
  id: string;
  name: string;
  code: string;
  netValue: number;
  dailyChange: number;
  tags: string[];
  isSelected: boolean;
}

interface FundCompany {
  id: string;
  name: string;
  logo: string; // ç”¨ Emoji ä»£æ›¿
  scale: string;
  fundCount: number;
  isSelected: boolean;
}

interface FundManager {
  id:string;
  name: string;
  avatar: string; // ç”¨ Emoji ä»£æ›¿
  experience: string;
  masterpiece: string;
  isSelected: boolean;
}

// ç­›é€‰å™¨æ ‡ç­¾æ¨¡å‹
interface FilterCategory {
  title: string;
  tags: string[];
  isExpanded: boolean;
}

// --- é™æ€æ¨¡æ‹Ÿæ•°æ® ---
// åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™äº›æ•°æ®åº”è¯¥é€šè¿‡ç½‘ç»œè¯·æ±‚ä»ä½ çš„åç«¯è·å–
const MOCK_FUNDS: Fund[] = [
  { id: 'f1', name: 'æŸæŸæˆé•¿æ··åˆA', code: '001234', netValue: 2.345, dailyChange: 1.23, tags: ['é«˜æˆé•¿', 'æ¶ˆè´¹'], isSelected: false },
  { id: 'f2', name: 'æŸæŸä»·å€¼ä¼˜é€‰', code: '005678', netValue: 1.876, dailyChange: -0.54, tags: ['ä»·å€¼å‹', 'å¤§ç›˜'], isSelected: false },
  { id: 'f3', name: 'æŸæŸç§‘æŠ€å…ˆé”‹', code: '009012', netValue: 3.102, dailyChange: 2.05, tags: ['ç§‘æŠ€', 'ä¸­å°ç›˜'], isSelected: false },
];

const MOCK_COMPANIES: FundCompany[] = [
  { id: 'c1', name: 'åå¤åŸºé‡‘', logo: 'ğŸ¢', scale: '1.2ä¸‡äº¿', fundCount: 350, isSelected: false },
  { id: 'c2', name: 'æ˜“æ–¹è¾¾åŸºé‡‘', logo: 'ğŸ¢', scale: '1.5ä¸‡äº¿', fundCount: 410, isSelected: false },
];

const MOCK_MANAGERS: FundManager[] = [
  { id: 'm1', name: 'å¼ ä¸‰', avatar: 'ğŸ‘¨â€ğŸ’¼', experience: '10å¹´', masterpiece: 'æŸæŸæˆé•¿æ··åˆA', isSelected: false },
  { id: 'm2', name: 'æå››', avatar: 'ğŸ‘©â€ğŸ’¼', experience: '8å¹´', masterpiece: 'æŸæŸä»·å€¼ä¼˜é€‰', isSelected: false },
];


// --- UI ç»„ä»¶ ---

/**
 * åŸºé‡‘ç”»åƒé¡µ (è¯¦æƒ…é¡µ) - è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å ä½é¡µé¢
 */
@Component
struct FundProfilePage {
  private fundName: string = "åŸºé‡‘ç”»åƒ";

  build() {
    Column() {
      // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå±•ç¤ºå¤æ‚çš„å›¾è¡¨å’Œæ•°æ®å¡ç‰‡
      Text(this.fundName)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      Text('æ­¤å¤„å±•ç¤ºåŸºé‡‘çš„è¯¦ç»†ä¿¡æ¯ã€å›¾è¡¨ã€æŒä»“ç­‰...').margin({top: 20})
    }
    .width('100%').height('100%').justifyContent(FlexAlign.Center)
  }
}

/**
 * ç­›é€‰å™¨é¢æ¿
 */
@Component
struct FilterPanel {
  // @Prop ç”¨äºæ¥æ”¶çˆ¶ç»„ä»¶å•å‘ä¼ é€’è¿‡æ¥çš„æ•°æ®
  @Prop filterCategories: FilterCategory[];
  // @Link ç”¨äºåŒå‘ç»‘å®šæ§åˆ¶é¢æ¿æ˜¾ç¤º/éšè—çš„çŠ¶æ€å˜é‡
  @Link isFilterPanelShown: boolean;

  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜
      Row() {
        Text("ç­›é€‰æ ‡ç­¾").fontSize(20).fontWeight(FontWeight.Bold)
        Blank() // å ä½ç¬¦ï¼Œå°†å…³é—­æŒ‰é’®æ¨åˆ°æœ€å³ä¾§
        Image($r("app.media.ic_close")) // å‡è®¾æœ‰å…³é—­å›¾æ ‡
          .width(24).height(24).onClick(() => this.isFilterPanelShown = false)
      }
      .width('100%').padding(15)

      // ç­›é€‰æ ‡ç­¾åˆ—è¡¨
      Scroll() {
        Column({ space: 10 }) {
          ForEach(this.filterCategories, (category: FilterCategory) => {
            // å¯æŠ˜å çš„åˆ†ç±»
            DisclosureGroup({
              isExpanded: category.isExpanded,
              onToggle: (isExpanded: boolean) => { category.isExpanded = isExpanded }
            }) {
              // åˆ†ç±»æ ‡é¢˜
              Text(category.title).fontSize(16).fontWeight(FontWeight.Medium)
            } content: {
              // æ ‡ç­¾å†…å®¹ï¼Œä½¿ç”¨æµå¼å¸ƒå±€
              Flex({ wrap: FlexWrap.Wrap, spacing: 8 }) {
                ForEach(category.tags, (tag: string) => {
                  Text(tag)
                    .padding({ horizontal: 12, vertical: 6 })
                    .backgroundColor('#f0f0f0')
                    .borderRadius(15)
                })
              }.padding({top: 10})
            }
          })
        }.padding({ horizontal: 15 })
      }
      .layoutWeight(1)

      // åº•éƒ¨æŒ‰é’®
      Row({ space: 10 }) {
        Button("é‡ç½®").type(ButtonType.Normal).backgroundColor('#e0e0e0').fontColor(Color.Black).layoutWeight(1)
        Button("ç¡®å®š").type(ButtonType.Capsule).layoutWeight(1).onClick(() => this.isFilterPanelShown = false)
      }
      .width('100%').padding(15)
    }
    .width('90%')
    .height('100%')
    .backgroundColor(Color.White)
    .align(Alignment.End) // è®©é¢æ¿ä»å³ä¾§æ»‘å…¥
  }
}

/**
 * ä¸»é¡µé¢
 */
@Entry
@Component
struct FundResearchPage {
  @State selectedTabIndex: number = 0;
  @State funds: Fund[] = MOCK_FUNDS;
  @State companies: FundCompany[] = MOCK_COMPANIES;
  @State managers: FundManager[] = MOCK_MANAGERS;
  @State isFilterPanelShown: boolean = false;
  @State selectedCount: number = 0;

  // ç­›é€‰å™¨æ•°æ®
  @State filterCategories: FilterCategory[] = [
    { title: 'ä¸šç»©è¡¨ç°', tags: ['è¿‘1å¹´é¢†å…ˆ', 'å¤æ™®æ¯”ç‡é«˜', 'å›æ’¤æ§åˆ¶å¥½'], isExpanded: true },
    { title: 'é£é™©åº¦é‡', tags: ['ä½æ³¢åŠ¨', 'é«˜é£é™©'], isExpanded: false },
    { title: 'åŸºé‡‘ç»ç†é£æ ¼', tags: ['æˆé•¿å‹', 'ä»·å€¼å‹', 'å¹³è¡¡å‹'], isExpanded: false }
  ];

  private tabsController: TabsController = new TabsController();

  // è®¡ç®—å½“å‰é€‰ä¸­çš„é¡¹ç›®æ•°é‡
  private updateSelectedCount() {
    let count = 0;
    if(this.selectedTabIndex === 0) {
      count = this.funds.filter(f => f.isSelected).length;
    } else if (this.selectedTabIndex === 1) {
      count = this.companies.filter(c => c.isSelected).length;
    } else {
      count = this.managers.filter(m => m.isSelected).length;
    }
    this.selectedCount = count;
  }


  build() {
    Stack() { // ä½¿ç”¨ Stack å †å å¸ƒå±€ï¼Œæ–¹ä¾¿æ”¾ç½®ç­›é€‰å™¨é¢æ¿å’Œæ‚¬æµ®æŒ‰é’®
      Column() {
        // 1. é¡¶éƒ¨å¯¼èˆª
        Tabs({ barPosition: BarPosition.Start, controller: this.tabsController }) {
          Tab("å…¨éƒ¨åŸºé‡‘") { this.FundList() }
          Tab("åŸºé‡‘å…¬å¸") { this.CompanyList() }
          Tab("åŸºé‡‘ç»ç†") { this.ManagerList() }
        }
        .onChange((index) => {
          this.selectedTabIndex = index;
          this.updateSelectedCount(); // åˆ‡æ¢tabæ—¶é‡æ–°è®¡ç®—é€‰ä¸­æ•°é‡
        })
        .layoutWeight(1)

      }
      .width('100%')
      .height('100%')

      // 2. ç­›é€‰å™¨é¢æ¿ (æ¡ä»¶æ¸²æŸ“)
      if (this.isFilterPanelShown) {
        // åŠé€æ˜é®ç½©å±‚
        Column()
          .width('100%').height('100%').backgroundColor(0x66000000)
          .onClick(() => this.isFilterPanelShown = false)
        // ç­›é€‰å™¨
        FilterPanel({
          filterCategories: this.filterCategories,
          isFilterPanelShown: $isFilterPanelShown
        })
      }

      // 3. æ‚¬æµ®æ“ä½œæŒ‰é’®
      this.FloatingActionButton()
    }
  }

  // æ„å»ºå™¨ï¼Œç”¨äºåˆ›å»ºå¯å¤ç”¨çš„UIç‰‡æ®µ

  // æœç´¢å’Œç­›é€‰æ 
  @Builder SearchAndFilterBar() {
    Row({ space: 10 }) {
      TextInput({ placeholder: 'æœç´¢ä»£ç /åç§°...' }).layoutWeight(1)
      Button() {
        Row({ space: 5 }) {
          Image($r("app.media.ic_filter")) // å‡è®¾æœ‰ç­›é€‰å›¾æ ‡
            .width(16).height(16).fillColor(Color.Black)
          Text("ç­›é€‰")
        }
      }
      .type(ButtonType.Normal).backgroundColor('#f0f0f0')
      .onClick(() => { this.isFilterPanelShown = true })
    }
    .padding(15)
  }

  // å…¨éƒ¨åŸºé‡‘åˆ—è¡¨
  @Builder FundList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        ForEach(this.funds, (fund: Fund) => {
          ListItem() {
            Row() {
              Toggle({ type: ToggleType.Checkbox, isOn: fund.isSelected })
                .onChange((isOn) => {
                  fund.isSelected = isOn;
                  this.updateSelectedCount();
                })
              Column({ space: 5 }) {
                Text(fund.name).fontSize(16).fontWeight(FontWeight.Bold)
                Row({ space: 8 }) {
                  Text(fund.code).fontColor(Color.Gray)
                  Text(`å‡€å€¼: ${fund.netValue.toFixed(3)}`).fontColor(Color.Gray)
                }
              }.alignItems(HorizontalAlign.Start).layoutWeight(1)

              Text(`${fund.dailyChange > 0 ? '+' : ''}${fund.dailyChange.toFixed(2)}%`)
                .fontColor(fund.dailyChange > 0 ? Color.Red : Color.Green)
                .fontSize(16).fontWeight(FontWeight.Bold)
            }
            .padding(15).backgroundColor(Color.White).borderRadius(12)
          }
          .onClick(() => {
            // è·³è½¬åˆ°åŸºé‡‘ç”»åƒé¡µï¼Œè¿™é‡Œç”¨ä¸€ä¸ªå¼¹çª—ä»£æ›¿
            AlertDialog.show({ title: 'åŸºé‡‘ç”»åƒ', message: `å³å°†è·³è½¬åˆ° ${fund.name} çš„è¯¦æƒ…é¡µã€‚`})
          })
        })
      }.padding({horizontal: 15})
    }
  }

  // åŸºé‡‘å…¬å¸åˆ—è¡¨
  @Builder CompanyList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        ForEach(this.companies, (company: FundCompany) => {
          ListItem() {
            Row() {
              Toggle({ type: ToggleType.Checkbox, isOn: company.isSelected })
                .onChange((isOn) => {
                  company.isSelected = isOn;
                  this.updateSelectedCount();
                })
              Text(company.logo).fontSize(30)
              Column({ space: 5 }) {
                Text(company.name).fontSize(16).fontWeight(FontWeight.Bold)
                Row({ space: 8 }) {
                  Text(`è§„æ¨¡: ${company.scale}`).fontColor(Color.Gray)
                  Text(`åŸºé‡‘æ•°: ${company.fundCount}`).fontColor(Color.Gray)
                }
              }.alignItems(HorizontalAlign.Start).layoutWeight(1).margin({ left: 15 })
            }.padding(15).backgroundColor(Color.White).borderRadius(12)
          }
        })
      }.padding({horizontal: 15})
    }
  }

  // åŸºé‡‘ç»ç†åˆ—è¡¨
  @Builder ManagerList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        ForEach(this.managers, (manager: FundManager) => {
          ListItem() {
            Row() {
              Toggle({ type: ToggleType.Checkbox, isOn: manager.isSelected })
                .onChange((isOn) => {
                  manager.isSelected = isOn;
                  this.updateSelectedCount();
                })
              Text(manager.avatar).fontSize(30)
              Column({ space: 5 }) {
                Text(manager.name).fontSize(16).fontWeight(FontWeight.Bold)
                Text(`ä»ä¸š: ${manager.experience} | ä»£è¡¨ä½œ: ${manager.masterpiece}`).fontColor(Color.Gray).fontSize(12)
              }.alignItems(HorizontalAlign.Start).layoutWeight(1).margin({ left: 15 })
            }.padding(15).backgroundColor(Color.White).borderRadius(12)
          }
        })
      }.padding({horizontal: 15})
    }
  }

  // æ‚¬æµ®æ“ä½œæŒ‰é’®
  @Builder FloatingActionButton() {
    Button() {
      Text(`å·²é€‰ ${this.selectedCount} | ä¿å­˜ä¸ºç»„åˆ`)
    }
    .type(ButtonType.Capsule)
    .width(200)
    .position({ x: '50%', y: '90%' }) // å®šä½åœ¨å±å¹•ä¸‹æ–¹
    .translate({ x: '-50%' }) // æ°´å¹³å±…ä¸­
    .enabled(this.selectedCount > 0) // å½“æœ‰é€‰ä¸­é¡¹æ—¶æ‰å¯ç”¨
    .opacity(this.selectedCount > 0 ? 1 : 0) // æœªé€‰ä¸­æ—¶é€æ˜
    .animation({ duration: 300, curve: Curve.EaseInOut }) // æ·»åŠ æ˜¾ç¤º/éšè—åŠ¨ç”»
  }
}