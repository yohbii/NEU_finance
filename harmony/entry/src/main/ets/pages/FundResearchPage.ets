// --- æ•°æ®æ¨¡å‹å®šä¹‰ ---
// å®šä¹‰äº†åº”ç”¨ä¸­ä½¿ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå¢å¼ºäº†ä»£ç çš„å¯è¯»æ€§å’Œç±»å‹å®‰å…¨ã€‚

/**
 * å•ä¸ªåŸºé‡‘çš„æ•°æ®æ¨¡å‹
 */
interface Fund {
  id: string; // å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåˆ—è¡¨æ¸²æŸ“çš„key
  name: string;
  code: string;
  netValue: number;
  dailyChange: number;
  tags: string[];
  isSelected: boolean; // ç”¨äºæ ‡è®°æ˜¯å¦è¢«ç”¨æˆ·å‹¾é€‰
}

/**
 * åŸºé‡‘å…¬å¸çš„æ•°æ®æ¨¡å‹
 */
interface FundCompany {
  id: string;
  name: string;
  logo: string; // ä½¿ç”¨ Emoji å­—ç¬¦ä¸²ä»£æ›¿å›¾ç‰‡èµ„æºï¼Œæ–¹ä¾¿ç§»æ¤
  scale: string;
  fundCount: number;
  isSelected: boolean;
}

/**
 * åŸºé‡‘ç»ç†çš„æ•°æ®æ¨¡å‹
 */
interface FundManager {
  id: string;
  name: string;
  avatar: string; // ä½¿ç”¨ Emoji å­—ç¬¦ä¸²
  experience: string;
  masterpiece: string;
  isSelected: boolean;
}

/**
 * ç­›é€‰å™¨åˆ†ç±»çš„æ•°æ®æ¨¡å‹
 */
interface FilterCategory {
  title: string;
  tags: string[];
  isExpanded: boolean; // æ§åˆ¶è¯¥åˆ†ç±»åœ¨UIä¸Šæ˜¯å¦å±•å¼€
}

// --- é™æ€æ¨¡æ‹Ÿæ•°æ® ---
// åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™äº›æ•°æ®åº”è¯¥é€šè¿‡APIä»åç«¯æœåŠ¡è·å–ã€‚
const MOCK_FUNDS: Fund[] = [
  { id: 'f1', name: 'æŸæŸæˆé•¿æ··åˆA', code: '001234', netValue: 2.345, dailyChange: 1.23, tags: ['é«˜æˆé•¿', 'æ¶ˆè´¹'], isSelected: false },
  { id: 'f2', name: 'æŸæŸä»·å€¼ä¼˜é€‰', code: '005678', netValue: 1.876, dailyChange: -0.54, tags: ['ä»·å€¼å‹', 'å¤§ç›˜'], isSelected: false },
  { id: 'f3', name: 'æŸæŸç§‘æŠ€å…ˆé”‹', code: '009012', netValue: 3.102, dailyChange: 2.05, tags: ['ç§‘æŠ€', 'ä¸­å°ç›˜'], isSelected: false },
];
const MOCK_COMPANIES: FundCompany[] = [
  { id: 'c1', name: 'åå¤åŸºé‡‘', logo: 'ğŸ¢', scale: '1.2ä¸‡äº¿', fundCount: 350, isSelected: false },
  { id: 'c2', name: 'æ˜“æ–¹è¾¾åŸºé‡‘', logo: 'ğŸ¢', scale: '1.5ä¸‡äº¿', fundCount: 410, isSelected: false },
];
const MOCK_MANAGERS: FundManager[] = [
  { id: 'm1', name: 'å¼ ä¸‰', avatar: 'ğŸ‘¨â€ğŸ’¼', experience: '10å¹´', masterpiece: 'æŸæŸæˆé•¿æ··åˆA', isSelected: false },
  { id: 'm2', name: 'æå››', avatar: 'ğŸ‘©â€ğŸ’¼', experience: '8å¹´', masterpiece: 'æŸæŸä»·å€¼ä¼˜é€‰', isSelected: false },
];


// --- UI ç»„ä»¶ ---

/**
 * åŸºé‡‘ç”»åƒé¡µ (è¯¦æƒ…é¡µ) - è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å ä½é¡µé¢
 * @Component è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¯å¤ç”¨çš„UIç»„ä»¶ã€‚
 */
@Component
struct FundProfilePage {
  private fundName: string = "åŸºé‡‘ç”»åƒ";
  build() {
    Column() {
      // åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå±•ç¤ºå¤æ‚çš„å›¾è¡¨å’Œæ•°æ®å¡ç‰‡
      Text(this.fundName).fontSize(24).fontWeight(FontWeight.Bold)
      Text('æ­¤å¤„å±•ç¤ºåŸºé‡‘çš„è¯¦ç»†ä¿¡æ¯ã€å›¾è¡¨ã€æŒä»“ç­‰...').margin({ top: 20 })
    }
    .width('100%').height('100%').justifyContent(FlexAlign.Center)
  }
}

/**
 * ç­›é€‰å™¨é¢æ¿ç»„ä»¶ï¼Œä»ä¾§è¾¹æ»‘å‡ºã€‚
 */
@Component
struct FilterPanel {
  // @Prop ç”¨äºæ¥æ”¶çˆ¶ç»„ä»¶å•å‘ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå­ç»„ä»¶ä¸å¯ä¿®æ”¹ã€‚
  @Prop filterCategories: FilterCategory[];
  // @Link ç”¨äºåŒå‘ç»‘å®šçˆ¶ç»„ä»¶çš„çŠ¶æ€å˜é‡ï¼Œå­ç»„ä»¶çš„ä¿®æ”¹ä¼šåŒæ­¥å›çˆ¶ç»„ä»¶ã€‚
  @Link isFilterPanelShown: boolean;

  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜å’Œå…³é—­æŒ‰é’®
      Row() {
        Text("ç­›é€‰æ ‡ç­¾").fontSize(20).fontWeight(FontWeight.Bold)
        Blank() // å ä½ç¬¦ï¼Œå°†å…³é—­æŒ‰é’®æ¨åˆ°æœ€å³ä¾§
        // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£æœ¬åœ°å›¾ç‰‡èµ„æºï¼Œé¿å…å› èµ„æºæ‰¾ä¸åˆ°è€ŒæŠ¥é”™
        Text('âŒ').fontSize(20).onClick(() => this.isFilterPanelShown = false)
      }
      .width('100%').padding(15)

      // ç­›é€‰æ ‡ç­¾åˆ—è¡¨
      Scroll() {
        Column({ space: 10 }) {
          // [ä¼˜åŒ–] ä¸º ForEach æ·»åŠ  keyï¼Œæå‡æ¸²æŸ“æ€§èƒ½
          ForEach(this.filterCategories, (category: FilterCategory) => {
            // DisclosureGroup: å¯æŠ˜å çš„UIå®¹å™¨
            DisclosureGroup({
              isExpanded: category.isExpanded,
              onToggle: (isExpanded: boolean) => { category.isExpanded = isExpanded }
            }) {
              Text(category.title).fontSize(16).fontWeight(FontWeight.Medium)
            } content: {
              // Flex: æµå¼å¸ƒå±€ï¼Œç”¨äºå±•ç¤ºæ ‡ç­¾äº‘
              Flex({ wrap: FlexWrap.Wrap, spacing: 8, alignItems: ItemAlign.Start }) {
                // [ä¼˜åŒ–] ä¸º ForEach æ·»åŠ  key
                ForEach(category.tags, (tag: string) => {
                  Text(tag)
                    .padding({ horizontal: 12, vertical: 6 })
                    .backgroundColor('#f0f0f0')
                    .borderRadius(15)
                }, tag => tag)
              }.padding({ top: 10 })
            }
          }, category => category.title)
        }.padding({ horizontal: 15 })
      }
      .layoutWeight(1)

      // åº•éƒ¨æ“ä½œæŒ‰é’®
      Row({ space: 10 }) {
        // [ä¼˜åŒ–] æ˜ç¡®ä¸»æ¬¡æ“ä½œï¼Œé‡ç½®æŒ‰é’®ä½¿ç”¨æ›´æ™®é€šçš„æ ·å¼
        Button("é‡ç½®").type(ButtonType.Normal).backgroundColor('#e0e0e0').fontColor(Color.Black).layoutWeight(1)
        Button("ç¡®å®š").type(ButtonType.Capsule).layoutWeight(1).onClick(() => this.isFilterPanelShown = false)
      }
      .width('100%').padding(15)
    }
    .width('90%').height('100%').backgroundColor(Color.White)
    .align(Alignment.End) // æŒ‡å®šç»„ä»¶åœ¨Stackä¸­çš„å¯¹é½æ–¹å¼ï¼Œå®ç°ä»å³ä¾§æ»‘å…¥çš„æ•ˆæœ
  }
}

/**
 * ä¸»é¡µé¢ï¼Œä½œä¸ºåº”ç”¨çš„å…¥å£ã€‚
 * @Entry è¡¨æ˜è¿™æ˜¯åº”ç”¨çš„å…¥å£é¡µé¢ã€‚
 */
@Entry
@Component
struct FundResearchPage {
  // @State æ ‡è®°çš„å˜é‡æ˜¯UIçš„çŠ¶æ€ï¼Œå½“å…¶å€¼æ”¹å˜æ—¶ï¼ŒUIä¼šè‡ªåŠ¨åˆ·æ–°ã€‚
  @State selectedTabIndex: number = 0;
  @State funds: Fund[] = MOCK_FUNDS;
  @State companies: FundCompany[] = MOCK_COMPANIES;
  @State managers: FundManager[] = MOCK_MANAGERS;
  @State isFilterPanelShown: boolean = false;
  @State selectedCount: number = 0;

  @State filterCategories: FilterCategory[] = [
    { title: 'ä¸šç»©è¡¨ç°', tags: ['è¿‘1å¹´é¢†å…ˆ', 'å¤æ™®æ¯”ç‡é«˜', 'å›æ’¤æ§åˆ¶å¥½'], isExpanded: true },
    { title: 'é£é™©åº¦é‡', tags: ['ä½æ³¢åŠ¨', 'é«˜é£é™©'], isExpanded: false },
    { title: 'åŸºé‡‘ç»ç†é£æ ¼', tags: ['æˆé•¿å‹', 'ä»·å€¼å‹', 'å¹³è¡¡å‹'], isExpanded: false }
  ];

  private tabsController: TabsController = new TabsController();

  /**
   * è®¡ç®—å½“å‰é€‰ä¸­çš„é¡¹ç›®æ•°é‡ã€‚è¿™æ˜¯ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œç”¨äºæ›´æ–°UIçŠ¶æ€ã€‚
   */
  private updateSelectedCount() {
    let count = 0;
    switch (this.selectedTabIndex) {
      case 0:
        count = this.funds.filter(f => f.isSelected).length;
        break;
      case 1:
        count = this.companies.filter(c => c.isSelected).length;
        break;
      case 2:
        count = this.managers.filter(m => m.isSelected).length;
        break;
    }
    this.selectedCount = count;
  }

  build() {
    // Stack æ˜¯ä¸€ç§å †å å¸ƒå±€ï¼Œåæ·»åŠ çš„ç»„ä»¶ä¼šè¦†ç›–åœ¨å…ˆæ·»åŠ çš„ç»„ä»¶ä¹‹ä¸Šã€‚
    // éå¸¸é€‚åˆå®ç°æ¨¡æ€å¼¹çª—ã€æ‚¬æµ®æŒ‰é’®ç­‰æ•ˆæœã€‚
    Stack() {
      Column() {
        Tabs({ barPosition: BarPosition.Start, controller: this.tabsController }) {
          Tab("å…¨éƒ¨åŸºé‡‘") { this.FundList() }
          Tab("åŸºé‡‘å…¬å¸") { this.CompanyList() }
          Tab("åŸºé‡‘ç»ç†") { this.ManagerList() }
        }
        .onChange((index) => {
          this.selectedTabIndex = index;
          this.updateSelectedCount(); // åˆ‡æ¢tabæ—¶ï¼Œé‡æ–°è®¡ç®—é€‰ä¸­é¡¹æ•°é‡
        })
        .layoutWeight(1) // ä½¿Tabsç»„ä»¶å¡«æ»¡çˆ¶å®¹å™¨çš„å‰©ä½™ç©ºé—´
      }
      .width('100%').height('100%')

      // æ ¹æ® isFilterPanelShown çš„å€¼ï¼Œæ¡ä»¶æ€§åœ°æ¸²æŸ“ç­›é€‰å™¨é¢æ¿å’Œé®ç½©å±‚
      if (this.isFilterPanelShown) {
        Column() // åŠé€æ˜é®ç½©å±‚
          .width('100%').height('100%').backgroundColor(0x66000000)
          .onClick(() => this.isFilterPanelShown = false)
        FilterPanel({
          filterCategories: this.filterCategories,
          isFilterPanelShown: $isFilterPanelShown // ä½¿ç”¨ $ ç¬¦å·å®ç° @Link çš„åŒå‘ç»‘å®š
        })
      }

      this.FloatingActionButton()
    }
  }

  // @Builder ç”¨äºå®šä¹‰å¯å¤ç”¨çš„UIç‰‡æ®µï¼Œå¯ä»¥åƒè°ƒç”¨å‡½æ•°ä¸€æ ·ä½¿ç”¨å®ƒã€‚

  @Builder SearchAndFilterBar() {
    Row({ space: 10 }) {
      TextInput({ placeholder: 'æœç´¢ä»£ç /åç§°...' }).layoutWeight(1)
      // [ä¼˜åŒ–] è°ƒæ•´æŒ‰é’®æ ·å¼ï¼Œä½¿å…¶æ›´å’Œè°
      Button() {
        Row({ space: 5 }) {
          // [ä¿®æ­£] ä½¿ç”¨ Emoji æ›¿ä»£å›¾æ ‡
          Text('ğŸ”').fontSize(14)
          Text("ç­›é€‰")
        }
      }
      .type(ButtonType.Capsule).backgroundColor('#e8e8e8').fontColor(Color.Black)
      .onClick(() => { this.isFilterPanelShown = true })
    }
    .padding(15)
  }

  @Builder FundList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        // [ä¼˜åŒ–] ä¸º ForEach æ·»åŠ  keyï¼Œæå‡æ¸²æŸ“æ€§èƒ½
        ForEach(this.funds, (fund: Fund) => {
          ListItem() {
            Row({ space: 10 }) { // å¢åŠ æ•´ä½“é—´è·
              // [ä¼˜åŒ–] ä¸º Toggle æ·»åŠ å³è¾¹è·ï¼Œä½¿å…¶ä¸ä¸å†…å®¹ç´§è´´
              Toggle({ type: ToggleType.Checkbox, isOn: fund.isSelected }).margin({ right: 5 })
                .onChange((isOn) => { fund.isSelected = isOn; this.updateSelectedCount(); })

              Column({ space: 5 }) {
                Text(fund.name).fontSize(16).fontWeight(FontWeight.Bold)
                Row({ space: 8 }) {
                  Text(fund.code).fontColor(Color.Gray)
                  Text(`å‡€å€¼: ${fund.netValue.toFixed(3)}`).fontColor(Color.Gray)
                }
              }.alignItems(HorizontalAlign.Start).layoutWeight(1)

              Text(`${fund.dailyChange > 0 ? '+' : ''}${fund.dailyChange.toFixed(2)}%`)
                .fontColor(fund.dailyChange > 0 ? Color.Red : Color.Green).fontSize(16).fontWeight(FontWeight.Bold)
            }.padding(15).backgroundColor(Color.White).borderRadius(12)
          }
          .onClick(() => { AlertDialog.show({ title: 'åŸºé‡‘ç”»åƒ', message: `å³å°†è·³è½¬åˆ° ${fund.name} çš„è¯¦æƒ…é¡µã€‚` }) })
        }, (fund: Fund) => fund.id)
      }.padding({ horizontal: 15 })
    }.backgroundColor('#f5f5f5') // [ä¼˜åŒ–] æ·»åŠ èƒŒæ™¯è‰²ï¼Œçªå‡ºå¡ç‰‡
  }

  @Builder CompanyList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        ForEach(this.companies, (company: FundCompany) => {
          ListItem() {
            Row() {
              Toggle({ type: ToggleType.Checkbox, isOn: company.isSelected }).margin({ right: 5 })
                .onChange((isOn) => { company.isSelected = isOn; this.updateSelectedCount(); })
              Text(company.logo).fontSize(30)
              Column({ space: 5 }) {
                Text(company.name).fontSize(16).fontWeight(FontWeight.Bold)
                Row({ space: 8 }) {
                  Text(`è§„æ¨¡: ${company.scale}`).fontColor(Color.Gray)
                  Text(`åŸºé‡‘æ•°: ${company.fundCount}`).fontColor(Color.Gray)
                }
              }.alignItems(HorizontalAlign.Start).layoutWeight(1).margin({ left: 15 })
            }.padding(15).backgroundColor(Color.White).borderRadius(12)
          }
        }, (company: FundCompany) => company.id)
      }.padding({ horizontal: 15 })
    }.backgroundColor('#f5f5f5')
  }

  @Builder ManagerList() {
    Column() {
      this.SearchAndFilterBar()
      List({ space: 10 }) {
        ForEach(this.managers, (manager: FundManager) => {
          ListItem() {
            Row() {
              Toggle({ type: ToggleType.Checkbox, isOn: manager.isSelected }).margin({ right: 5 })
                .onChange((isOn) => { manager.isSelected = isOn; this.updateSelectedCount(); })
              Text(manager.avatar).fontSize(30)
              Column({ space: 5 }) {
                Text(manager.name).fontSize(16).fontWeight(FontWeight.Bold)
                Text(`ä»ä¸š: ${manager.experience} | ä»£è¡¨ä½œ: ${manager.masterpiece}`).fontColor(Color.Gray).fontSize(12)
              }.alignItems(HorizontalAlign.Start).layoutWeight(1).margin({ left: 15 })
            }.padding(15).backgroundColor(Color.White).borderRadius(12)
          }
        }, (manager: FundManager) => manager.id)
      }.padding({ horizontal: 15 })
    }.backgroundColor('#f5f5f5')
  }

  @Builder FloatingActionButton() {
    Button() {
      Text(`å·²é€‰ ${this.selectedCount} | ä¿å­˜ä¸ºç»„åˆ`)
    }
    .type(ButtonType.Capsule).width(200)
    // ä½¿ç”¨ position + translate çš„ç»„åˆå¯ä»¥ç²¾ç¡®åœ°å°†æŒ‰é’®å±…ä¸­æ”¾ç½®
    .position({ x: '50%', y: '90%' }).translate({ x: '-50%' })
    .enabled(this.selectedCount > 0) // å½“æœ‰é€‰ä¸­é¡¹æ—¶æŒ‰é’®æ‰å¯ç”¨
    // æ ¹æ®é€‰ä¸­æ•°é‡åŠ¨æ€æ”¹å˜é€æ˜åº¦ï¼Œå®ç°æ·¡å…¥æ·¡å‡ºæ•ˆæœ
    .opacity(this.selectedCount > 0 ? 1 : 0)
    // ä¸º opacity çš„å˜åŒ–æ·»åŠ åŠ¨ç”»ï¼Œä½¿å…¶è¿‡æ¸¡æ›´å¹³æ»‘
    .animation({ duration: 300, curve: Curve.EaseInOut })
  }
}